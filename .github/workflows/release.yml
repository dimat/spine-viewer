# Release workflow: build macOS + Windows and publish a GitHub Release when a version tag is pushed.
# Version is taken from the tag (e.g. v1.0.0). Use conventional commits so release notes look good.
#
# How to release:
#   1. Bump version in package.json (e.g. npm version patch) and push, or create tag only (see below).
#   2. Create and push a tag:  git tag v1.0.0 && git push origin v1.0.0
#   3. This workflow runs, builds both platforms, and creates the release with artifacts.

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: win
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          node -e "
          const fs = require('fs');
          const v = process.env.VERSION || '';
          const p = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          p.version = (v || '').replace(/^v/, '');
          fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "
        env:
          VERSION: ${{ github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Build macOS artifacts
        if: matrix.platform == 'mac'
        run: npm run dist

      - name: Build Windows artifacts
        if: matrix.platform == 'win'
        run: npm run dist:win

      - name: Upload macOS artifacts
        if: matrix.platform == 'mac'
        uses: actions/upload-artifact@v4
        with:
          name: dist-mac
          path: dist/*.dmg

      - name: Upload Windows artifacts
        if: matrix.platform == 'win'
        uses: actions/upload-artifact@v4
        with:
          name: dist-win
          path: dist/*.exe

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-mac

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-win

      - name: Debug artifact layout
        run: |
          echo "=== workspace ==="
          ls -la
          echo "=== dist-mac ==="
          ls -la dist-mac 2>/dev/null || echo "dist-mac missing"
          find dist-mac -type f 2>/dev/null || true
          echo "=== dist-win ==="
          ls -la dist-win 2>/dev/null || echo "dist-win missing"
          find dist-win -type f 2>/dev/null || true

      - name: Gather release assets
        run: |
          mkdir -p release-assets
          # Copy all files from both artifacts (handles any nested or flat layout)
          find dist-mac -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          find dist-win -type f -exec cp {} release-assets/ \; 2>/dev/null || true
          echo "=== release-assets ==="
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Spine Viewer ${{ github.ref_name }}
          generate_release_notes: true
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
